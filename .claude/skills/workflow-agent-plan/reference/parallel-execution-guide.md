# 병렬 실행 최적화 가이드

planner가 병렬 실행 계획을 수립할 때 참조하는 상세 가이드입니다. Phase 분배, 워커 수 결정, 컨텍스트 관리, 태스크 그룹화, 종속성 분석에 대한 구체적 기준과 수치를 제공합니다.

> **출처 표기 규칙**: 각 수치/권장값에 출처를 명시합니다. 공식 문서 기반은 "(출처: Anthropic 공식 문서)"로, 커뮤니티/운영 경험 기반은 `<!-- 공식 하드리밋 아님, 운영 권장값 -->` 주석으로 표기합니다.

---

## Phase 분배 전략

### 독립 태스크 식별 체크리스트

태스크가 다음 **모든 조건**을 만족하면 독립 태스크로 분류하여 동일 Phase에 병렬 배치할 수 있다.

| # | 체크 항목 | 설명 |
|---|----------|------|
| 1 | 파일 경계 분리 | 수정 대상 파일이 다른 태스크와 겹치지 않음 |
| 2 | 출력-입력 무관 | 이 태스크의 산출물이 다른 태스크의 입력이 아님 |
| 3 | 공유 상태 없음 | 전역 설정, DB 스키마, 공유 타입 정의 등을 동시에 수정하지 않음 |
| 4 | 빌드 종속성 없음 | 이 태스크의 빌드 결과물을 다른 태스크가 참조하지 않음 |
| 5 | 도메인 독립 | 서로 다른 모듈/디렉터리/도메인에 속함 |

<!-- 공식 하드리밋 아님, 운영 권장값 (claudefa.st 베스트 프랙티스 기반) -->

### Phase 배치 최적화 규칙

| 규칙 | 설명 | 예시 |
|------|------|------|
| 독립 태스크 병렬화 | 체크리스트 5항목 모두 충족 시 동일 Phase | W01(API), W02(UI), W03(DB) -> Phase 1 병렬 |
| 종속 태스크 후속 배치 | 선행 태스크 산출물이 필요하면 다음 Phase | W01(조사) -> W02, W03(구현) |
| 약한 참조 병렬 허용 | "참고"만 하고 필수 입력이 아닌 경우 동일 Phase 가능 | W01(가이드 작성), W02(테스트 작성, W01 참고) |
| Phase 내 균등 배분 | 한 Phase에 복잡도가 극단적으로 다른 태스크 혼합 지양 | T2(8)과 T1(2)를 같은 Phase에 배치하면 T1 워커가 유휴 |
| 최소 Phase 원칙 | Phase 수를 최소화하여 전체 실행 시간 단축 | 3개 독립 태스크 -> 3 Phase(순차) 대신 1 Phase(병렬) |

---

## 워커 수 최적화

### Phase당 적정 워커 수 결정 기준

서브에이전트 병렬 실행에 대한 **공식 하드리밋은 존재하지 않는다** (출처: Anthropic 공식 문서). 아래는 공식 권장값과 커뮤니티 운영 경험을 종합한 가이드라인이다.

| 기준 | 권장 워커 수 | 출처 |
|------|-------------|------|
| 일반 권장 (대부분의 워크플로우) | **3-5개** | (출처: Anthropic 공식 문서, Agent Teams) |
| 경량 작업 (파일 처리, git 작업, 문서 생성) | 5-6개 | <!-- 공식 하드리밋 아님, 운영 권장값 (macOS M4 Pro 24GB 환경 기준) --> |
| 중간 작업 (빌드, 린팅, 코드 리뷰) | 3-4개 | <!-- 공식 하드리밋 아님, 운영 권장값 --> |
| 중량 작업 (대규모 파일 처리, 통합 테스트) | 2개 | <!-- 공식 하드리밋 아님, 운영 권장값 --> |
| 커뮤니티 권장 상한 | 3-4개 | <!-- 공식 하드리밋 아님, 운영 권장값 (pubnub.com 베스트 프랙티스) --> |

### 워커 수 결정 시 고려 사항

| 고려 사항 | 설명 |
|-----------|------|
| 토큰 비용 선형 증가 | N개 워커 = 약 N배 토큰 소비. 3-teammate 팀은 단일 세션 대비 3-4배 (출처: Anthropic 공식 문서) |
| 조율 오버헤드 | 워커 수 증가 시 오케스트레이터의 태스크 조율/컨텍스트 관리 복잡화 (출처: Anthropic 공식 문서) |
| 수확체감 | 특정 수를 넘으면 추가 워커가 비례적 속도 향상을 제공하지 못함 (출처: Anthropic 공식 문서) |
| API 레이트 리밋 | 워커가 과도하게 활성화되면 API rate limit 도달 가능 <!-- 공식 하드리밋 아님, 운영 권장값 (zachwills.net 경험 보고) --> |
| 시스템 리소스 | 저사양 환경(2vCPU/4GB)에서 과도한 병렬 실행 시 시스템 무응답 발생 사례 보고 <!-- 공식 하드리밋 아님, 운영 권장값 (GitHub Issue #15487) --> |

---

## 컨텍스트 200K 관리

### 에이전트 컨텍스트 윈도우 기본 수치

| 항목 | 값 | 출처 |
|------|-----|------|
| 에이전트당 컨텍스트 윈도우 | 200K 토큰 | (출처: Anthropic 공식 문서) |
| 베타 확장 컨텍스트 | 1M 토큰 | (출처: Anthropic 공식 문서, 베타) |
| 오토-컴팩션 트리거 | 약 95% 용량 도달 시 | (출처: Anthropic 공식 문서) |
| 서브에이전트 컨텍스트 | 각 서브에이전트 독립 200K 보유 | (출처: Anthropic 공식 문서) |

### 태스크 유형별 예상 컨텍스트 소비량 추정 가이드

각 워커(서브에이전트)는 독립적인 200K 컨텍스트를 보유한다. 아래는 태스크 유형별 예상 소비 비율이다.

<!-- 공식 하드리밋 아님, 운영 권장값 (실행 경험 기반 추정치) -->

| 태스크 유형 | 예상 소비 비율 | 예상 토큰 | 비고 |
|-------------|---------------|----------|------|
| 단일 파일 수정 (100줄 이하) | 10-20% | 20K-40K | Read + Edit 1-2회 |
| 복수 파일 수정 (3-5개 파일) | 30-50% | 60K-100K | 여러 파일 Read + 컨텍스트 누적 |
| 대규모 파일 수정 (500줄 이상) | 40-60% | 80K-120K | 대형 파일 Read로 컨텍스트 급증 |
| 웹 조사 (WebSearch/WebFetch) | 50-70% | 100K-140K | 외부 콘텐츠 로드로 빠른 소비 |
| 빌드/테스트 실행 | 20-40% | 40K-80K | Bash 출력 누적 |
| 코드 생성 (신규 파일) | 20-30% | 40K-60K | Write 위주, Read 적음 |
| 통합 작업 (조사 + 구현) | 60-80% | 120K-160K | 복합 도구 사용으로 빠른 소비 |

### 컨텍스트 절약 원칙

| 원칙 | 설명 |
|------|------|
| 서브에이전트 결과 축약 | 서브에이전트의 상세 결과가 메인 컨텍스트로 귀환하면 메인 컨텍스트 급증. 결과는 파일에 기록하고 경로만 반환 (출처: Anthropic 공식 문서 경고) |
| 태스크 범위 한정 | 한 워커에 과도한 Read 대상을 부여하지 않음 |
| 오토-컴팩션 인지 | 95% 도달 시 자동 컴팩션이 트리거되므로, 태스크 후반부에 중요 정보가 손실될 수 있음 |
| 대형 파일 분할 Read | 500줄 이상 파일은 offset/limit으로 필요 부분만 Read |

---

## 태스크 그룹화

### 마이크로 태스크 그룹화 기준

관련된 마이크로 태스크를 단일 워커로 그룹화하면 워커 수를 줄이고 컨텍스트 공유 효율을 높일 수 있다.

| 기준 | 설명 | 예시 |
|------|------|------|
| 동일 파일 수정 | 같은 파일을 수정하는 태스크는 반드시 단일 워커 | 파일 A의 함수 추가 + 파일 A의 타입 수정 -> 1워커 |
| 동일 도메인 | 같은 모듈/디렉터리의 관련 작업 | API 엔드포인트 추가 + API 테스트 작성 -> 1워커 |
| 소규모 연쇄 | 출력->입력이 연쇄되는 소규모 태스크 | 타입 정의 생성 -> 해당 타입 사용 함수 구현 -> 1워커 |
| 복잡도 합산 T2 이하 | 그룹화된 태스크의 복잡도 합이 T2(15) 이하 | T1(3) + T1(4) + T1(5) = 12 -> 그룹화 적합 |

<!-- 공식 하드리밋 아님, 운영 권장값 -->

### 그룹화 판단 플로우

```
태스크 목록 확인
    |
    v
동일 파일을 수정하는 태스크 쌍이 있는가? --예--> 반드시 그룹화 (충돌 방지)
    |
   아니오
    |
    v
동일 도메인이고 복잡도 합 T2 이하인가? --예--> 그룹화 권장
    |
   아니오
    |
    v
출력->입력 연쇄가 있고 각각 T1인가? --예--> 그룹화 권장
    |
   아니오
    |
    v
독립 태스크로 분리하여 병렬 배치
```

### 그룹화 적정 규모

| 항목 | 권장값 | 출처 |
|------|--------|------|
| 워커당 태스크 수 | 5-6개 | (출처: Anthropic 공식 문서, Agent Teams) |
| 워커당 최대 태스크 수 | 7개 | <!-- 공식 하드리밋 아님, 운영 권장값 --> |
| 단일 워커 투입 기준 | 2일 이내 작업량 | <!-- 공식 하드리밋 아님, 운영 권장값 (zachwills.net 권장) --> |
| 초과 시 분해 기준 | 2-3개 하위 태스크로 분해 | <!-- 공식 하드리밋 아님, 운영 권장값 --> |

---

## 종속성 분석 강화

### 병렬 가능한 태스크 쌍 식별 패턴

| 패턴 | 설명 | 병렬 가능 여부 |
|------|------|---------------|
| 독립 도메인 구현 | 서로 다른 모듈/패키지의 기능 구현 | **병렬 가능** |
| 독립 파일 생성 | 신규 파일을 각각 생성하고 서로 참조하지 않음 | **병렬 가능** |
| 읽기 전용 참조 | 동일 파일을 Read만 하고 수정하지 않음 | **병렬 가능** |
| 다른 레이어 작업 | 프론트엔드/백엔드/DB 각각 독립 작업 | **병렬 가능** |
| 테스트 + 문서 | 구현 완료 후 테스트와 문서를 각각 작성 | **병렬 가능** |
| 조사 + 조사 | 서로 다른 주제의 웹 조사 | **병렬 가능** |

### 순차 실행 필수 (반패턴) 목록

아래 패턴은 병렬 실행 시 충돌, 데이터 손실, 비일관성을 유발하므로 **반드시 순차 실행**해야 한다.

| 반패턴 | 위험 | 올바른 배치 |
|--------|------|------------|
| 동일 파일 동시 수정 | 한쪽 변경 덮어쓰기, 머지 충돌 | 같은 Phase 금지, 순차 또는 그룹화 |
| 출력->입력 종속 | 선행 산출물 미완성 상태에서 참조 | 선행 태스크를 앞 Phase에 배치 |
| 공유 타입/스키마 동시 변경 | 타입 불일치, 컴파일 에러 | 타입 변경 태스크를 앞 Phase에 배치 |
| 빌드 결과 의존 | 빌드 산출물 미생성 상태에서 참조 | 빌드 태스크를 앞 Phase에 배치 |
| 전역 설정 동시 수정 | 설정값 충돌, 예기치 않은 동작 | 설정 변경을 단일 워커에 집중 |
| 순차 마이그레이션 | 마이그레이션 순서 꼬임 | 반드시 순차 실행 |

### 종속성 판별 결정 테이블

| 판별 질문 | 예 -> | 아니오 -> |
|-----------|-------|----------|
| 태스크 A의 산출물을 태스크 B가 읽는가? | 순차 (A -> B) | 다음 질문 |
| 동일 파일을 A와 B가 모두 수정하는가? | 순차 또는 그룹화 | 다음 질문 |
| A와 B가 공유 타입/인터페이스를 변경하는가? | 순차 (타입 변경 선행) | 다음 질문 |
| A와 B가 동일 전역 설정을 수정하는가? | 그룹화 (단일 워커) | 다음 질문 |
| A와 B가 완전히 독립적인 도메인인가? | **병렬 가능** | 안전 확인 후 판단 |

---

## 참고 자료

| 자료 | URL |
|------|-----|
| Anthropic 공식 문서 - Sub-Agents | https://code.claude.com/docs/en/sub-agents |
| Anthropic 공식 문서 - Agent Teams | https://code.claude.com/docs/en/agent-teams |
| GitHub Issue #15487 (maxParallelAgents 설정 요청) | https://github.com/anthropics/claude-code/issues/15487 |
| claudefa.st - Sub-Agent Best Practices | https://claudefa.st/blog/guide/agents/sub-agent-best-practices |
| pubnub.com - Sub-Agent Best Practices | https://www.pubnub.com/blog/best-practices-for-claude-code-sub-agents/ |
| zachwills.net - Parallelize Development | https://zachwills.net/how-to-use-claude-code-subagents-to-parallelize-development/ |
| dev.to - Sub-Agents Token Burn | https://dev.to/onlineeric/claude-code-sub-agents-burn-out-your-tokens-4cd8 |
| nxcode.io - Agent Teams Guide 2026 | https://www.nxcode.io/resources/news/claude-agent-teams-parallel-ai-development-guide-2026 |
